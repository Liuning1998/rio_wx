<!--pages/orders/show/index.wxml-->
<wxs module="helper" src="./helper.wxs"></wxs>
<wxs module="helperTime" src="../index/helper.wxs"></wxs>
<wxs module="rhelper" src="../../../utils/helper.wxs"></wxs>
<wxs module="price" src="../../../utils/price.wxs"></wxs>
<wxs module="couponAfter" src="../confirm/coupon.wxs"></wxs>
<wxs module="utilsHelper" src="../../../utils/helper.wxs"></wxs>

<navbar navbarStyle="custom" customImgSrc="{{ (order.refund_state == null &&  order.state != 'canceled' && order.state != 'handle_canceled' &&  order.state != 'new' &&  order.state != 'padding') ? '/images/v1.2/order_bg_01.png' : '/images/v1.2/order_detailbg_01.png'}}" title="订单详情" />

<scroll-view scroll-y class='page-container'>
  <view class='page-content {{ isIphoneX && "iphone-x" }}'>

    <view class="header">
      <image wx:if="{{order.refund_state == null &&  order.state != 'canceled' && order.state != 'handle_canceled' &&  order.state != 'new' &&  order.state != 'padding' }}" class="bg-img" src="/images/v1.2/order_bg_01.png"></image>
      <image wx:else class="bg-img-noexpress" src="/images/v1.2/order_detailbg_01.png"></image>

      <view style='padding-top: {{pageMarginTop + 44}}px;'></view>

      <view class="slogan">
        <block wx:if="{{order.refund_state != null}}">此订单已退款，欢迎再次购买~</block>
        <block wx:elif="{{ order.state == 'canceled' || order.state == 'handle_canceled' }}">此订单已取消</block>
        <block wx:elif="{{ order.state == 'new' }}">等待支付( {{utilsHelper.getM(helperTime.payLeftTime(order, nowTime)) }}分{{ utilsHelper.getS(helperTime.payLeftTime(order, nowTime))}}秒 )</block>

        <block wx:elif="{{ order.state == 'padding' }}" >
          <block wx:if="{{ order.order_type == 4 || order.order_type == 5 }}">已付款等待商家发货~</block>
          <block wx:else>
            <block  wx:if="{{ order.sale_state == 'new' }}">订单售后中</block>
            <block  wx:elif="{{ order.sale_state == 'completed' }}">售后完成</block>
            <block wx:else>此订单已支付，正在发货~</block>
          </block>
        </block>

        <block wx:elif="{{ order.state == 'shipping' }}">
          <block wx:if="{{ order.order_type != 4 && order.order_type != 5 }}">
            <block  wx:if="{{ order.sale_state == 'new' }}">订单售后中</block>
            <block  wx:elif="{{ order.sale_state == 'completed' }}">售后完成</block>
            <block wx:else>您的快递正在飞奔向您~</block>
          </block>
          <block wx:else>您的快递正在飞奔向您~</block>
        </block>
        <block wx:else>订单完成，感谢您的支持~~</block>
      </view>

      <view class="state" wx:if="{{order.state != 'canceled' && order.state != 'handle_canceled' && order.sale_state == null}}">
        <view class="state-text">
          <view class="text">已下单</view>
          <view class="text">已付款</view>
          <view class="text">待收货</view>
          <view class="text">已完成</view>
        </view>
        <view class="state-icon {{orderStep}}">
          <view class="icon">
            <view class="icon-round"><image src="/images/v1.2/order_02.png"></image></view>
          </view>
          <view class="icon">
            <view class="icon-round"><image src="/images/v1.2/order_01.png"></image></view>
          </view>
          <view class="icon">
            <view class="icon-round"><image src="/images/v1.2/order_04.png"></image></view>
          </view>
          <view class="icon ">
            <view class="icon-round"><image src="/images/v1.2/order_03.png"></image></view>
          </view>
        </view>
      </view>

      <view class="express" wx:if="{{order.refund_state == null &&  order.state != 'canceled' && order.state != 'handle_canceled' &&  order.state != 'new' &&  order.state != 'padding' }}" bindtap="gotoExpress" data-expresses="{{order.expresses}}">
        <view class="express-box">
          <view class="express-l">
            <!-- 多个包裹 -->
            <block wx:if="{{order.expresses.length > 1}}">
              <view class="text">
                <text class="title">多个包裹</text>当前订单已拆分为{{order.expresses.length}}个包裹 
              </view>
            </block>
            <!-- 一个包裹 -->
            <block wx:else>
              <view class="text">
                <text class="title">最新物流</text>{{expressInfo.data[expressInfo.data.length - 1].context}}
              </view>
              <view class="time">{{expressInfo.data[expressInfo.data.length - 1].time}}</view>
            </block>
          </view>
          <image class="express-r" src="/images/v1.2/arrow.png"></image>
        </view>
      </view>

      <!-- 取消和售后 -->
      <view class="express" wx:if="{{ order.state == 'canceled' || order.state == 'handle_canceled' || order.order.sale_state != null }}" bindtap="gotoExpress" data-expresses="{{order.expresses}}">
        <view class="express-box">
          <view class="express-l">
            <!-- 售后 -->
            <block wx:if="{{order.state == 'canceled' || order.state == 'handle_canceled'}}">
              <view class="text">
                <text class="title">取消进度</text>订单超时未支付，系统自动取消订单，若有需要您可再次购买。
              </view>
            </block>
            <!-- 一个包裹 -->
            <block wx:else>
              <block wx:if="{{order.order.sale_state == 'new'}}">
              </block>
              <block wx:else></block>
              <view class="text">
                <text class="title">最新物流</text>{{expressInfo.data[expressInfo.data.length - 1].context}}
              </view>
              <view class="time">{{expressInfo.data[expressInfo.data.length - 1].time}}</view>
            </block>
          </view>
          <image class="express-r" src="/images/v1.2/arrow.png"></image>
        </view>
      </view>
      
      <view class="order-title">
        <image class="icon" src="/images/v1.2/shops.png"></image>
        <view class="name">金色家园</view>
        <view class="to-kf" data-url="/pages/contact/index" bindtap="gotoLink">联系客服</view>
      </view>

      <view class="product">
        <view class="item" wx:if="{{index < showProductQuantity}}"  bindtap="gotoProduct" data-url="/pages/products/show/index?id={{ item.product.id }}" wx:for="{{order.line_items}}" wx:for-item="item" wx:key="index">
          <view class="item-top">
            <view class="avatar">
              <image src="{{item.product.avatar}}"></image>
            </view>
            <view class="name">{{item.product.name}}</view>
            <view class="money">
              <view class="top">
                <text>¥</text>{{item.price}}
              </view>
              <view class="bottom">×{{item.quantity}}</view>
            </view>
          </view>
          <view class="item-btnbox">
            <view class="btn" wx:if="{{order.refund_state == null && order.state != 'canceled' && order.state != 'handle_canceled' && order.state != 'new' }}">申请售后</view>
          </view>
        </view>
        <view class="show-all {{showProductQuantity > 2 && 'shou'}}" data-length="{{order.line_items.length}}" bindtap="seeAll" wx:if="{{order.line_items.length > 2}}">
          <block wx:if="{{showProductQuantity == 2}}">查看全部</block>
          <block wx:else>收起</block>
          <image src="/images/v1.2/arrow_01.png"></image>
        </view>
      </view>

      <view class="product-info">
        <view class="item">
          <view class="text">商品总价</view>
          <view class="money"><text>¥</text>{{ order.total }}</view>
        </view>
        <view class="item" wx:if="{{order.shipment_expense > 0}}">
          <view class="text">运费(快递)</view>
          <view class="money"><text>+ ¥</text>{{order.shipment_expense}}</view>
        </view>
        <view class="item" wx:if="{{ !!order.vip_info && order.vip_info.name > 0 && order.vip_info.value > 0 && price.vipDiscount(order.line_items, userInfo,order.promotions[0].value)}}">
          <view class="text">{{vip_level.current_vip_level}}会员专享{{order.vip_info.name}}折</view>
          <view class="money"><text>- ¥</text>{{ order.vip_info.value }}</view>
        </view>
      </view>

      <view class="product-info-all">
        <text class="quantity">共{{order.product_total}}件商品</text>
        <text class="text">实付款:</text>
        <text class="unit">¥</text>
        <text class="money">{{ order.discount_total }}</text>
        <text class="text" wx:if="{{order.shipment_expense <= 0}}">(免运费)</text>
      </view>

    </view>
    
    <view class="order-info">
      <view class="title">订单信息</view>
      <view class="item"  wx:if="{{ order.ship_address != null && !(order.state == 'canceled' || order.state == 'handle_canceled') }}">
        <view class="name">收货信息：</view>
        <view class="info"><text>{{order.ship_address.real_name || ''}}，{{rhelper.hidePhone(order.ship_address.phone) || ''}}</text><text>{{order.ship_address.province || ''}}{{order.ship_address.city || ''}}{{order.ship_address.district || ''}}{{order.ship_address.town || ''}}{{order.ship_address.address_info || ''}}</text></view>
      </view>
      <view class="item copy-box">
        <view class="name">订单编号:</view>
        <view class="info">{{ order.number }}</view>
        <view class="copy" bindtap="copyNumber">复制</view>
      </view>
      <view class="item">
        <view class="name">下单时间:</view>
        <view class="info">{{ order.created_at_t }}</view>
      </view>
      <view class="item">
        <view class="name">支付时间:</view>
        <view class="info" wx:if="{{ order.paid_at_t != null }}">{{ order.paid_at_t }}</view>
      </view>
      <view class="item" wx:if="{{ order.pay_method.pay_balance_total != null &&  order.pay_method.pay_balance_total != 0 }}">
        <view class="name">平台余额支付金额:</view>
        <view class="info">¥ {{ order.pay_method.pay_balance_total }}</view>
      </view>
      <view class="item" wx:if="{{ order.pay_method.pay_cash_total != null && order.pay_method.pay_cash_total != 0 }}">
        <view class="name">实际支付金额:</view>
        <view class="info">¥ {{ order.pay_method.pay_cash_total }}</view>
      </view>
      <view class="item" wx:if="{{ order.payment_state == 'new' && order.balance_expend != null && order.balance_expend.status == 'lock' && order.balance_expend.cash_pre_total > 0 }}">
        <view class="name">平台余额已抵扣:</view>
        <view class="info">¥ {{ order.balance_expend.cash_pre_total }}</view>
      </view>
      <view class="item" wx:if="{{ order.payment_state == 'new' && order.balance_expend != null && order.balance_expend.status == 'unlock' && balance > 0}}">
        <view class="name">平台余额:{{balance}}元</view>
        <view class="switch">
          <text>是否使用平台余额抵扣</text>
          <switch checked="{{isBalance}}" color="#FB2C2A" bindchange="switchBalance"/> 
        </view>
        
      </view>
    </view>

  </view>
</scroll-view>

<view class='bottom-btn-group  {{ isIphoneX && "iphone-x" }}'>
  <view wx:if="{{ order.state == 'new' }}" class="btn-content">
    <view class="total">
      <text>合计:</text>
      <text>¥</text>
      <text>{{order.discount_total}}</text>
    </view>
    <text bindtap="cancelOrder" class="btn cancel" >取消订单</text>
    <text  bindtap="showPayMethod" class="btn pay" >支付{{utilsHelper.getM(helperTime.payLeftTime(order, nowTime)) }}:{{ utilsHelper.getS(helperTime.payLeftTime(order, nowTime)) }}</text>
  </view>

  <view wx:else class="btn-content">
    <text wx:if="{{order.sale_state != 'new' && order.state == 'completed' || order.state == 'canceled' || order.state == 'handle_canceled' }}" bindtap="deleteOrder" class="btn delete" >删除订单</text>
    <block wx:if="{{helper.canService(order)}}">
      <text class="btn cancel" wx:if="{{orderServiceStatus.click == 'on'}}" bindtap="orderService" >申请售后</text>
      <!-- <text class="btn cancel" wx:else bindtap="orderService">查看售后</text> -->
    </block>
    <text wx:if="{{ order.order_type != 4 && order.order_type != 5 }}" bindtap="buyAgain" class="btn buy">再次购买</text>
  </view>
</view>

<view wx:if="{{showPayNotice}}" class="pay-notice-container">
  <view class="pay-notice-content">
    <view class="pn-header">
      <!-- <image class="close" src="/images/close_white.png"></image> -->
      <text bindtap="payNoticeCancelBtn" class="close">x</text>
    </view>

    <view class="pn-content">
      <!-- <text class="pn-text" decode="{{true}}">
        &nbsp;&nbsp;&nbsp;&nbsp;在微信支付确认弹框中选择支付方式为：<text style="color: #f00;">{{payNotice}}</text>
      </text> -->
      <rich-text class="pn-text" nodes='{{payNotice}}'></rich-text>
      <view class="protocol">
        <view bindtap="changePayNoticeProtocol" class="checkbox {{ payNoticeProtocolStatus && 'active' }}"><image src="/images/select.png"></image></view>
        <view>
          <text bindtap="changePayNoticeProtocol" class="btn">下次不再提醒</text>
          <!-- <text bindtap="gotoLink" data-url="/agreement/pages/try_product/index" class="protocol-item">《试用规则》</text> -->
        </view>
      </view>

      <view class="btn-group">
        <text bindtap="payNoticeCancelBtn" class="btn cancel">取消</text>
        <text bindtap="payNoticeConfirmBtn" class="btn confirm">确认</text>
      </view>
    </view>
  </view>
</view>

<!-- 选择支付方式 -->
<view wx:if="{{ showPayMethodLayer }}" class="pay-method-layer">
  <!-- 纯余额支付 wx:if="{{couponAfter.balance_total(order.discount_total,balance) == 0 && isBalance}}" -->
  <view class="pay-method-container balance" wx:if="{{ order.balance_expend.status == 'unlock' && isBalance && couponAfter.balance_total(order.discount_total,balance) <= 0 }}">
    <view class="pm-header">
      <!-- <image class="close" src="/images/close_white.png"></image> -->
      <text>平台余额支付</text>
      <!-- <text bindtap="hidePayMethod" class="close">x</text> -->
      <view class="close" bindtap="closePay"><view class="close-icon"></view></view>
    </view>
    <view class="pay-method-content">
      <text class="total">￥{{ couponAfter.balance_deduct(order.discount_total,balance) }}</text>
    </view>

    <view class="name">江海千里（北京）科技有限公司</view>
    <view class="number">订单编号：{{order.number}}</view>

    <view class="bottom-btns {{ isIphoneX && 'iphone-x' }}">
      <text class="pay-method-confirm" bindtap="getBalancePayInfo">确定</text>
    </view>
  </view>
  <view class="pay-method-container" wx:else>
    <view class="pm-header">
      <!-- <image class="close" src="/images/close_white.png"></image> -->
      <text>选择支付方式</text>
      <!-- <text bindtap="hidePayMethod" class="close">x</text> -->
      <view class="close" bindtap="closePay"><view class="close-icon"></view></view>
    </view>
    <view class="pay-method-content">
      <!-- 订单被锁 -->
      <block wx:if="{{order.balance_expend.status == 'lock'}}">
        <text class="total">￥{{ order.balance_expend.cash_pre_total > 0 ? couponAfter.balance_total(order.discount_total,order.balance_expend.cash_pre_total) : order.discount_total }}</text>
        <text wx:if="{{order.balance_expend.cash_pre_total > 0}}" class="balance">平台余额已抵扣￥{{ order.balance_expend.cash_pre_total }}</
        text>
      </block>
      <!-- 订单没被锁 -->
      <block wx:else>
        <text class="total">￥{{ isBalance ? couponAfter.balance_total(order.discount_total,balance) : order.discount_total }}</text>
        <text wx:if="{{isBalance}}" class="balance">平台余额已抵扣￥{{ couponAfter.balance_deduct(order.discount_total,balance) }}</text>
      </block>

      <view bindtap="selectBrcbPay" class="pay-method-item">
        <!-- <view class="checkbox {{ payMethod == 'brcb_pay' && 'active' }}"><image src="/images/select.png"></image></view> -->
        <image class="icon" src="/images/yanglaozhucanka_icon.png"></image>
        <view class="item-main">
          <text class="label">养老助残卡支付</text>
          <view class="pay-menthod-checkbox {{ payMethod == 'brcb_pay' && 'active' }}">
            <image class="checkbox-icon" src="/images/selected_icon_003.png"></image>
          </view>
        </view>
      </view>

      <view class="pay-method-item" bindtap="selectWxPay">
        <!-- <view class="checkbox {{ payMethod == 'wx_pay' && 'active' }}"><image src="/images/select.png"></image></view> -->
        <image class="icon" src="/images/weixin_icon.png"></image>
        <view class="item-main">
          <text class="label">微信支付</text>
          <view class="pay-menthod-checkbox {{ payMethod == 'wx_pay' && 'active' }}">
            <image class="checkbox-icon" src="/images/selected_icon_003.png"></image>
          </view>
        </view>
      </view>
    </view>

    <view class="bottom-btns {{ isIphoneX && 'iphone-x' }}">
      <text class="pay-method-confirm" bindtap="confirmPayMethod">确定</text>
    </view>
  </view>
</view>
<!-- 选择支付方式 -->

<!-- 纯余额支付结果弹窗 -->
<view class="balance-result" wx:if="{{balancePayResult != null}}" style='margin-top: {{pageMarginTop}}px; padding-top: 44px;'>
  <view class="subject">
    <block wx:if="{{balancePayResult}}">
      <image class="img" src="/images/pay_success.png"></image>
      <view class="result">支付成功</view>
    </block>
    <block wx:else>
      <image class="img" src="/images/pay_fail.png"></image>
      <view class="result">支付失败</view>
    </block>
    <view class="money">¥{{ order.discount_total }}</view>
    <view class="info">
      <view class="info-l">
        <view>订单编号</view>
        <view>{{order.number}}</view>
      </view>
      <view class="info-l">
        <view>下单时间</view>
        <view>{{order.created_at_t}}</view>
      </view>
    </view>
  </view>
  <view class="btn-box">
    <view class="btn btn-home" bindtap="goHome">返回首页</view>
    <view class="btn btn-order" bindtap="detailGoOrder">查看订单</view>
  </view>
</view>

<msgToast msg-data="{{ _msgData }}"/>